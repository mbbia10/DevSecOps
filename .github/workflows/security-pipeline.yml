name: Security Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  security:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. GITLEAKS (principal - FALHA SE encontrar algo)
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        with:
          fail: true
          report-format: sarif
          report-path: gitleaks-report.sarif

      # 2. TRUFFLEHOG (apenas reporta, n√£o falha)
      - name: TruffleHog Scan
        id: trufflehog
        continue-on-error: true  # üëà N√ÉO FALHA O PIPELINE
        run: |
          echo "üö® Executando TruffleHog (apenas reporte)..."
          docker run --rm -v "$(pwd):/workdir" trufflesecurity/trufflehog:latest \
            filesystem /workdir \
            --json \
            --only-verified \
            | tee trufflehog-report.json || true
          
          # Conta findings
          if [ -f trufflehog-report.json ]; then
            COUNT=$(jq length trufflehog-report.json 2>/dev/null || echo "0")
            echo "Found $COUNT verified secrets"
          fi

      # 3. CHECKOV
      - name: Checkov Scan (IaC)
        continue-on-error: true  # Reporta mas n√£o falha
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          quiet: true
          skip_check: "CKV_DOCKER_2,CKV_DOCKER_3,CKV_DOCKER_7"

      # 4. BUILD
      - name: Build Docker image
        run: docker build -t app-segura .

      # 5. RELAT√ìRIO FINAL
      - name: Security Summary
        if: always()  # üëà SEMPRE EXECUTA, mesmo com falhas
        run: |
          echo "========================================"
          echo "         RESUMO DE SEGURAN√áA           "
          echo "========================================"
          echo ""
          
          # Status do Gitleaks
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "‚úÖ Gitleaks: NENHUM SECRET ENCONTRADO"
          else
            echo "‚ùå Gitleaks: SECRETS ENCONTRADOS!"
            echo "   Cheque o log acima para detalhes"
          fi
          
          echo ""
          echo "üîç TruffleHog: Executou (n√£o falha pipeline)"
          echo "üèóÔ∏è  Checkov: Executou (n√£o falha pipeline)"
          echo "üê≥ Docker: Build realizado com sucesso"
          echo ""
          echo "========================================"
          echo "Dica: O Gitleaks √© o scanner principal."
          echo "TruffleHog findings n√£o bloqueiam o merge."
          echo "========================================"